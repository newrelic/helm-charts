suite: test API Key secret
templates:
  - templates/example-apikey-secret.yaml
release:
  name: my-release
  namespace: my-namespace
tests:
  - it: errors if apiKey is empty
    set:
      global: null
      apiKey: null
    asserts:
      - failedTemplate:
          errorMessage: You must specify a apiKey or a customAPIKeySecretName containing it
  - it: creates secret with local license key
    set:
      global: null
      apiKey: local
    asserts:
      - equal:
          path: data.apiKey
          value: bG9jYWw=  # echo -n local | base64
  - it: creates secret with global license key
    set:
      apiKey: null
      global:
        apiKey: global
    asserts:
      - equal:
          path: data.apiKey
          value: Z2xvYmFs  # echo -n global | base64
  - it: local overrides global
    set:
      apiKey: local
      global:
        apiKey: global
    asserts:
      - equal:
          path: data.apiKey
          value: bG9jYWw=  # echo -n local | base64

  - it: does not create a secret if one is provided locally
    set:
      apiKey: I exist but will be ignored
      customAPIKeySecretName: foo
    asserts:
      - hasDocuments:
          count: 0
  - it: does not create a secret if one is provided globally
    set:
      apiKey: I exist but will be ignored
      global:
        customAPIKeySecretName: foo
    asserts:
      - hasDocuments:
          count: 0
