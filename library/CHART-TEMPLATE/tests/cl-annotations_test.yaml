suite: test annotations helpers
templates:
  - templates/integration-deployment.yaml
  - templates/sidecar-deployment.yaml
release:
  name: my-release
  namespace: my-namespace
tests:
  - it: does not fail if is set to nil
    set:
      global: null
      podAnnotations: null
      deploymentAnnotations: null
    asserts:
      - hasDocuments:
          count: 1

  - it: sets deployment's annotations according to values
    set:
      deploymentAnnotations:
        external-dns.alpha.kubernetes.io/hostname: a-fake-dns.tld
        external-dns.alpha.kubernetes.io/ttl: "300"
    asserts:
      - equal:
          path: metadata.annotations
          value:
            external-dns.alpha.kubernetes.io/hostname: a-fake-dns.tld
            external-dns.alpha.kubernetes.io/ttl: "300"

  - it: sets deployment's annotations with globals
    set:
      global:
        deploymentAnnotations:
          metallb.universe.tf/address-pool: a-pool
    asserts:
      - equal:
          path: metadata.annotations
          value:
            metallb.universe.tf/address-pool: a-pool

  - it: sets pod's annotations according to values
    set:
      podAnnotations:
        external-dns.alpha.kubernetes.io/hostname: a-fake-dns.tld
        external-dns.alpha.kubernetes.io/ttl: "300"
    asserts:
      - equal:
          path: spec.template.metadata.annotations
          value:
            external-dns.alpha.kubernetes.io/hostname: a-fake-dns.tld
            external-dns.alpha.kubernetes.io/ttl: "300"

  - it: sets pod's annotations with globals
    set:
      global:
        podAnnotations:
          metallb.universe.tf/address-pool: a-pool
    asserts:
      - equal:
          path: spec.template.metadata.annotations
          value:
            metallb.universe.tf/address-pool: a-pool

  - it: sets annotations with values overridding globals
    set:
      deploymentAnnotations:
        external-dns.alpha.kubernetes.io/hostname: a-fake-dns.tld
        external-dns.alpha.kubernetes.io/ttl: "300"
        metallb.universe.tf/address-pool: other-pool
      podAnnotations:
        external-dns.alpha.kubernetes.io/hostname: a-fake-dns.tld
        external-dns.alpha.kubernetes.io/ttl: "300"
        metallb.universe.tf/address-pool: other-pool
      global:
        deploymentAnnotations:
          metallb.universe.tf/address-pool: a-pool
        podAnnotations:
          metallb.universe.tf/address-pool: a-pool
    asserts:
      - equal:
          path: metadata.annotations
          value:
            external-dns.alpha.kubernetes.io/hostname: a-fake-dns.tld
            external-dns.alpha.kubernetes.io/ttl: "300"
            metallb.universe.tf/address-pool: other-pool
      - equal:
          path: spec.template.metadata.annotations
          value:
            external-dns.alpha.kubernetes.io/hostname: a-fake-dns.tld
            external-dns.alpha.kubernetes.io/ttl: "300"
            metallb.universe.tf/address-pool: other-pool
