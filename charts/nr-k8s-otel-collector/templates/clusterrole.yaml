{{- if include "newrelic.common.serviceAccount.create" . }}
---
# ClusterRole for StatefulSet collector
# Permissions: cluster-wide resources for prometheus scraping and k8sattributes enrichment
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRole
metadata:
  name: {{ include "nrKubernetesOtel.deployment.serviceAccountName" . }}
  labels:
  {{- include "newrelic.common.labels" . | nindent 4 }}
    app.kubernetes.io/component: statefulset-collector
rules:
  # Required for k8sattributes processor to enrich telemetry with Kubernetes metadata
  - apiGroups: [""]
    resources:
      - nodes
      - services
      - endpoints
      - pods
      - events
      - namespaces
    verbs: ["get", "list", "watch"]
  # Required for k8sattributes processor to enrich telemetry with workload metadata
  - apiGroups: ["apps"]
    resources:
      - replicasets
      - deployments
      - daemonsets
      - statefulsets
    verbs: ["get", "list", "watch"]
  # Required for k8sattributes processor to enrich telemetry with job metadata
  - apiGroups: ["batch"]
    resources:
      - jobs
      - cronjobs
    verbs: ["get", "list", "watch"]
  # Required for prometheus receiver to discover service monitors and pod monitors
  - apiGroups: [""]
    resources:
      - configmaps
    verbs: ["get"]
  # Required for Target Allocator to discover prometheus scrape targets
  - apiGroups: ["discovery.k8s.io"]
    resources:
      - endpointslices
    verbs: ["get", "list", "watch"]
  # Required for prometheus receiver to scrape metrics from non-resource URLs (e.g., /metrics)
  - nonResourceURLs:
      - /metrics
    verbs: ["get"]
---
# ClusterRole for DaemonSet collector
# Permissions: node-local resources for kubeletstats receiver and k8sattributes enrichment
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRole
metadata:
  name: {{ include "nrKubernetesOtel.daemonset.serviceAccountName" . }}
  labels:
  {{- include "newrelic.common.labels" . | nindent 4 }}
    app.kubernetes.io/component: daemonset-collector
rules:
  # Required for kubeletstats receiver to collect node and pod metrics
  - apiGroups: [""]
    resources:
      - nodes
      - nodes/proxy
      - nodes/stats
      - nodes/metrics
    verbs: ["get", "list", "watch"]
  # Required for k8sattributes processor to enrich telemetry with pod metadata
  - apiGroups: [""]
    resources:
      - pods
      - namespaces
    verbs: ["get", "list", "watch"]
  # Required for k8sattributes processor to enrich telemetry with workload metadata
  - apiGroups: ["apps"]
    resources:
      - replicasets
      - deployments
      - daemonsets
      - statefulsets
    verbs: ["get", "list", "watch"]
  # Required for Target Allocator to discover and distribute prometheus scrape targets
  - apiGroups: [""]
    resources:
      - services
      - endpoints
      - configmaps
    verbs: ["get", "list", "watch"]
  - apiGroups: ["discovery.k8s.io"]
    resources:
      - endpointslices
    verbs: ["get", "list", "watch"]
  - apiGroups: ["networking.k8s.io"]
    resources:
      - ingresses
    verbs: ["get", "list", "watch"]
  - apiGroups: ["monitoring.coreos.com"]
    resources:
      - servicemonitors
      - podmonitors
    verbs: ["*"]
  # Required for prometheus receiver to scrape cadvisor and kubelet metrics
  - nonResourceURLs:
      - /metrics
      - /metrics/cadvisor
      - /api
      - /api/*
      - /apis
      - /apis/*
    verbs: ["get"]
{{- end -}}
