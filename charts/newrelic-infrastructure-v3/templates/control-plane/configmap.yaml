{{- if .Values.controlPlane.enabled -}}
apiVersion: v1
kind: ConfigMap
metadata:
  namespace: {{ .Release.Namespace }}
  labels:
    {{- include "newrelic.labels" . | nindent 4 }}
  name: {{ template "newrelic.fullname" . }}-control-plane
data:
  nri-kubernetes.yml: |-
    {{- .Values.common.config | toYaml | nindent 4 }}
    controlPlane:
      enabled: true

    {{- if  .Values.controlPlane.config.etcd.enabled }}
      etcd:
        {{- $dataETCD :=  include "newrelic.compatibility.control-plane" (dict "autodiscover" .Values.controlPlane.config.etcd.autodiscover "staticEndpoint" .Values.controlPlane.config.etcd.staticEndpoint "etcdEndpointUrl" .Values.etcdEndpointUrl ) -}}
        {{- mustMergeOverwrite .Values.controlPlane.config.etcd  ($dataETCD | fromYaml) | toYaml | nindent 8 -}}
    {{- end -}}

    {{- if .Values.controlPlane.config.scheduler.enabled }}
      scheduler:
        {{- $dataScheduler :=  include "newrelic.compatibility.control-plane" (dict "autodiscover" .Values.controlPlane.config.scheduler.autodiscover "staticEndpoint" .Values.controlPlane.config.scheduler.staticEndpoint "etcdEndpointUrl" .Values.schedulerEndpointUrl ) -}}
        {{- mustMergeOverwrite .Values.controlPlane.config.scheduler  ($dataScheduler | fromYaml) | toYaml | nindent 8 -}}
    {{- end -}}

    {{- if  .Values.controlPlane.config.controllerManager.enabled }}
      controllerManager:
        {{- $dataController :=  include "newrelic.compatibility.control-plane" (dict "autodiscover" .Values.controlPlane.config.controllerManager.autodiscover "staticEndpoint" .Values.controlPlane.config.controllerManager.staticEndpoint "etcdEndpointUrl" .Values.controllerManagerEndpointUrl ) -}}
        {{- mustMergeOverwrite .Values.controlPlane.config.controllerManager  ($dataController | fromYaml) | toYaml | nindent 8 -}}
    {{- end -}}

    {{- if .Values.controlPlane.config.apiServer.enabled }}
      apiServer:
        {{- $dataApiServer :=  include "newrelic.compatibility.control-plane" (dict "autodiscover" .Values.controlPlane.config.apiServer.autodiscover "staticEndpoint" .Values.controlPlane.config.apiServer.staticEndpoint "etcdEndpointUrl" .Values.apiServerEndpointUrl ) -}}
        {{- mustMergeOverwrite .Values.controlPlane.config.apiServer  ($dataApiServer | fromYaml) | toYaml | nindent 8 -}}
    {{- end -}}
{{- end -}}
