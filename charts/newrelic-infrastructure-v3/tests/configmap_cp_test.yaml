suite: test configmap
templates:
  - templates/control-plane/configmap.yaml
tests:
  - it: without any option the chart still render a valid yaml
    set:
      licenseKey: test
      cluster: test
      controlPlane.config.etcd.autodiscover: []
      controlPlane.config.apiServer.enabled: false
      controlPlane.config.controllerManager.enabled: false
      controlPlane.config.scheduler.enabled: false
    asserts:
      - equal:
          path: data.nri-kubernetes\.yml
          value: |-
            interval: 15s
            timeout: 30s
            controlPlane:
              enabled: true
              etcd:
                autodiscover: []
                enabled: true
  - it: etcdEndpointUrl value is taken into account since no staticEndpoint is defined for etcd
    set:
      licenseKey: test
      cluster: test
      controlPlane.config.etcd.autodiscover: []
      controlPlane.config.apiServer.enabled: false
      controlPlane.config.controllerManager.enabled: false
      controlPlane.config.scheduler.enabled: false
      etcdEndpointUrl: http://test.io:9090/test
    asserts:
      - equal:
          path: data.nri-kubernetes\.yml
          value: |-
            interval: 15s
            timeout: 30s
            controlPlane:
              enabled: true
              etcd:
                autodiscover: []
                enabled: true
                staticEndpoint:
                  auth:
                    type: bearer
                  insecureSkipVerify: true
                  url: http://test.io:9090/test
  - it: etcdEndpointUrl value is ignored since staticEndpoint is defined for etcd
    set:
      licenseKey: test
      cluster: test
      controlPlane.config.etcd.autodiscover: []
      controlPlane.config.apiServer.enabled: false
      controlPlane.config.controllerManager.enabled: false
      controlPlane.config.scheduler.enabled: false
      controlPlane.config.etcd.staticEndpoint:
        url: http://test2.io:9090/test2
        insecureSkipVerify: false
      etcdEndpointUrl: http://test.io:9090/test
    asserts:
      - equal:
          path: data.nri-kubernetes\.yml
          value: |-
            interval: 15s
            timeout: 30s
            controlPlane:
              enabled: true
              etcd:
                autodiscover: []
                enabled: true
                staticEndpoint:
                  insecureSkipVerify: false
                  url: http://test2.io:9090/test2
  - it: a valid yaml is generated with all components and options enabled
    set:
      licenseKey: test
      cluster: test
      controlPlane.config.etcd.autodiscover: []
      controlPlane.config.apiServer.autodiscover: []
      controlPlane.config.controllerManager.autodiscover: []
      controlPlane.config.scheduler.autodiscover: []
      controlPlane.config.apiServer.enabled: true
      controlPlane.config.controllerManager.enabled: true
      controlPlane.config.scheduler.enabled: true
      etcdEndpointUrl: http://etcd/test
      controlPlane.config.etcd.staticEndpoint:
        url: http://test2.io:9090/test2
        insecureSkipVerify: false
      schedulerEndpointUrl: http://scheduler/test
      controllerManagerEndpointUrl: http://controller/test
      apiServerEndpointUrl: http://apiServer/test
    asserts:
      - equal:
          path: data.nri-kubernetes\.yml
          value: |-
            interval: 15s
            timeout: 30s
            controlPlane:
              enabled: true
              etcd:
                autodiscover: []
                enabled: true
                staticEndpoint:
                  insecureSkipVerify: false
                  url: http://test2.io:9090/test2
              scheduler:
                autodiscover: []
                enabled: true
                staticEndpoint:
                  auth:
                    type: bearer
                  insecureSkipVerify: true
                  url: http://scheduler/test
              controllerManager:
                autodiscover: []
                enabled: true
                staticEndpoint:
                  auth:
                    type: bearer
                  insecureSkipVerify: true
                  url: http://controller/test
              apiServer:
                autodiscover: []
                enabled: true
                staticEndpoint:
                  auth:
                    type: bearer
                  insecureSkipVerify: true
                  url: http://apiServer/test
  - it: autodiscovery section is rendered as expected together with the static Endpoint
    set:
      licenseKey: test
      cluster: test
      controlPlane.config.apiServer.enabled: false
      controlPlane.config.controllerManager.enabled: false
      controlPlane.config.scheduler.enabled: false
      controlPlane.config.etcd.staticEndpoint:
        url: http://test2.io:9090/test2
        insecureSkipVerify: false
      controlPlane.config.etcd.autodiscover:
        - selector: "tier=control-plane,component=etcd"
          namespace: kube-system
          matchNode: true
          endpoints:
            - url: http://localhost:2381
      etcdEndpointUrl: http://test.io:9090/test
    asserts:
      - equal:
          path: data.nri-kubernetes\.yml
          value: |-
            interval: 15s
            timeout: 30s
            controlPlane:
              enabled: true
              etcd:
                autodiscover:
                - endpoints:
                  - url: http://localhost:2381
                  matchNode: true
                  namespace: kube-system
                  selector: tier=control-plane,component=etcd
                enabled: true
                staticEndpoint:
                  insecureSkipVerify: false
                  url: http://test2.io:9090/test2
