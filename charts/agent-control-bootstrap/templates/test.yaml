{{- $testPodName := include "newrelic.common.naming.truncateToDNSWithSuffix" ( dict "name" (include "newrelic.common.naming.fullname" .) "suffix" "helm-test" ) -}}
apiVersion: v1
kind: Pod
metadata:
  name: {{ $testPodName }}
  namespace: {{ .Release.Namespace }}
  labels:
    {{- include "newrelic.common.labels" . | nindent 4 }}
  annotations:
    helm.sh/hook: test
    # removing the pod after the hook prevent to fetch the logs from helm cli
    helm.sh/hook-delete-policy: before-hook-creation
spec:
  restartPolicy: Never
  serviceAccountName: {{ $testPodName }}
  containers:
  - name: log-scraper
    image: {{ include "newrelic.common.images.image" ( dict "imageRoot" .Values.toolkitImage "context" .) }}
    imagePullPolicy: {{ .Values.toolkitImage.pullPolicy }}
    resources:
      limits:
        cpu: 100m
        memory: 128Mi
      requests:
        cpu: 50m
        memory: 64Mi
    command: ["/bin/sh", "-c"]
    args:
      - |
        # This is not a test but a workaround to print the installations Jobs logs in case of failure to provide a better 
        # feedback for the user.
        # Jobs are executed with Helm hooks and configured so the Pods don't get removed in case of failure.
        # Helm V4 is already providing an alternative https://github.com/helm/community/blob/main/hips/hip-0019.md#specification

        kubectl logs -l batch.kubernetes.io/job-name --prefix --tail=-1 -n {{ .Release.Namespace }}

        echo "‚ùå Installation has failed! The logs are displayed above."
        echo "üìñ For troubleshooting guidance, please check: https://docs.newrelic.com/docs/new-relic-control/agent-control/troubleshooting/#helm-release-failure"
        
        # This is not a test
        exit 0

---
apiVersion: v1
kind: ServiceAccount
metadata:
  name: {{ $testPodName }}
  namespace: {{ .Release.Namespace }}
  labels:
    {{- include "newrelic.common.labels" . | nindent 4 }}

---
apiVersion: rbac.authorization.k8s.io/v1
kind: Role
metadata:
  name: {{ $testPodName }}
  namespace: {{ .Release.Namespace }}
  labels:
    {{- include "newrelic.common.labels" . | nindent 4 }}
rules:
- apiGroups: [""]
  resources: ["pods"]
  verbs: ["get", "list"]
- apiGroups: [""]
  resources: ["pods/log"]
  verbs: ["get", "list"]

---
apiVersion: rbac.authorization.k8s.io/v1
kind: RoleBinding
metadata:
  name: {{ $testPodName }}
  namespace: {{ .Release.Namespace }}
  labels:
    {{- include "newrelic.common.labels" . | nindent 4 }}
subjects:
- kind: ServiceAccount
  name: {{ $testPodName }}
  namespace: {{ .Release.Namespace }}
roleRef:
  kind: Role
  name: {{ $testPodName }}
  apiGroup: rbac.authorization.k8s.io

