suite: Validate AC deployment secret render
chart:
  appVersion: 0.0.0

tests:
  - it: should render expected defaults
    asserts:
      - template: templates/ac-deployment-secret.yaml
        equal:
          decodeBase64: true
          path: data["agent-control-deployment.yaml"]
          value: |-
            config:
              cdReleaseName: agent-control-cd
            subAgentsNamespace: newrelic

  - it: should set cdRemoteUpdate as false when agentControlCd is disabled
    set:
      agentControlCd:
        enabled: false
    asserts:
      - template: templates/ac-deployment-secret.yaml
        equal:
          decodeBase64: true
          path: data["agent-control-deployment.yaml"]
          value: |-
            config:
              cdRemoteUpdate: false
            subAgentsNamespace: newrelic

  - it: should override cdRemoteUpdate when agentControlCd is disabled
    set:
      agentControlDeployment:
        chartValues:
          config:
            cdRemoteUpdate: true
            extraNestedValues: unchanged
          extraValues: unchanged
      agentControlCd:
        enabled: false
    asserts:
      - template: templates/ac-deployment-secret.yaml
        equal:
          decodeBase64: true
          path: data["agent-control-deployment.yaml"]
          value: |-
            config:
              cdRemoteUpdate: false
              extraNestedValues: unchanged
            extraValues: unchanged
            subAgentsNamespace: newrelic

  - it: should override config.cdReleaseName when agentControlCd is enabled
    set:
      agentControlDeployment:
        chartValues:
          config:
            cdReleaseName: to override
            extraNestedValues: unchanged
          extraValues: unchanged
      agentControlCd:
        enabled: enabled
        releaseName: custom-cd-release
    asserts:
      - template: templates/ac-deployment-secret.yaml
        equal:
          decodeBase64: true
          path: data["agent-control-deployment.yaml"]
          value: |-
            config:
              cdReleaseName: custom-cd-release
              extraNestedValues: unchanged
            extraValues: unchanged
            subAgentsNamespace: newrelic

  - it: should not override cdRemoteUpdate when agentControlCd is enabled
    set:
      agentControlDeployment:
        chartValues:
          config:
            cdRemoteUpdate: false
      agentControlCd:
        enabled: true
    asserts:
      - template: templates/ac-deployment-secret.yaml
        equal:
          decodeBase64: true
          path: data["agent-control-deployment.yaml"]
          value: |-
            config:
              cdReleaseName: agent-control-cd
              cdRemoteUpdate: false
            subAgentsNamespace: newrelic
