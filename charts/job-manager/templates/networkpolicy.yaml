# Job Manager NetworkPolicy - Controls ingress/egress for Job Manager pods
{{- if .Values.networkPolicy.enabled -}}
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: {{ include "job-manager.fullname" . }}
  namespace: {{ .Release.Namespace }}
  labels:
    {{- include "job-manager.labels" . | nindent 4 }}
    app.kubernetes.io/component: network-policy
spec:
  podSelector:
    matchLabels:
      {{- include "job-manager.selectorLabels" . | nindent 6 }}
  policyTypes:
    - Ingress
    - Egress
  ingress:
    {{- if .Values.networkPolicy.ingress }}
    {{- toYaml .Values.networkPolicy.ingress | nindent 4 }}
    {{- else }}
    # Allow ingress from runtime pods for job result reporting
    - from:
        - namespaceSelector:
            matchLabels:
              {{- toYaml .Values.networkPolicy.defaultRuntimeNamespaceSelector | nindent 14 }}
      ports:
        - protocol: TCP
          port: {{ .Values.service.port | default 8080 }}
    {{- end }}
  egress:
    {{- if .Values.networkPolicy.egress }}
    {{- toYaml .Values.networkPolicy.egress | nindent 4 }}
    {{- else }}
    # Allow egress to K8s API server for managing runtime resources
    - to:
        - namespaceSelector: {}
      ports:
        - protocol: TCP
          port: 443
        - protocol: TCP
          port: 6443
    # Allow egress to DNS for service discovery
    - to:
        - namespaceSelector:
            matchLabels:
              kubernetes.io/metadata.name: kube-system
      ports:
        - protocol: UDP
          port: 53
        - protocol: TCP
          port: 53
    # Allow egress to broker/orchestrator platform
    - to:
        - namespaceSelector: {}
      ports:
        - protocol: TCP
          port: 443
    {{- if .Values.networkPolicy.allowEgressToInternet }}
    # Allow all egress to internet (can be restricted further in production)
    - to:
        - ipBlock:
            cidr: 0.0.0.0/0
            except:
              # Block cloud metadata APIs
              - 169.254.169.254/32
    {{- end }}
    {{- end }}
{{- end }}
---
# Worker NetworkPolicy - Egress protection for worker pods (sidecar + runtime containers)
{{- if .Values.workerNetworkPolicy.enabled -}}
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: {{ include "job-manager.fullname" . }}-worker-egress-protection
  namespace: {{ .Values.workerNetworkPolicy.workerNamespace | default .Release.Namespace }}
  labels:
    {{- include "job-manager.labels" . | nindent 4 }}
    app.kubernetes.io/component: worker-network-policy
spec:
  podSelector:
    matchLabels:
      {{- toYaml .Values.workerNetworkPolicy.workerPodSelector | nindent 6 }}
  policyTypes:
    - Egress
  egress:
    # 1. THE EXCEPTION: Allow access to the Job Manager (Control Plane)
    - to:
        - namespaceSelector:
            matchLabels:
              kubernetes.io/metadata.name: {{ .Values.workerNetworkPolicy.jobManagerNamespace | default .Release.Namespace | quote }}
          podSelector:
            matchLabels:
              {{- include "job-manager.selectorLabels" . | nindent 14 }}
      ports:
        - protocol: TCP
          port: {{ .Values.service.port | default 8080 }}

    # 2. Allow DNS resolution
    # DNS server IPs (e.g., 10.96.0.10) fall in blocked private ranges.
    # Without this exception, domain name resolution fails for all services and external URLs.
    - to:
        - namespaceSelector:
            matchLabels:
              kubernetes.io/metadata.name: {{ .Values.workerNetworkPolicy.dns.namespace | default "kube-system" | quote }}
          podSelector:
            matchLabels:
              {{- if .Values.workerNetworkPolicy.dns.podSelector }}
              {{- toYaml .Values.workerNetworkPolicy.dns.podSelector | nindent 14 }}
              {{- else }}
              k8s-app: kube-dns
              {{- end }}
      ports:
        - protocol: UDP
          port: 53
        - protocol: TCP
          port: 53

    # 3. Allow access to Kubernetes API server (automatically detected)
    {{- $kubernetesService := lookup "v1" "Service" "default" "kubernetes" }}
    {{- if $kubernetesService }}
    - to:
        - ipBlock:
            cidr: {{ $kubernetesService.spec.clusterIP }}/32
      ports:
        - protocol: TCP
          port: 443
    {{- else }}
    {{- fail "Cannot automatically detect Kubernetes API server IP. Ensure 'kubernetes' service exists in 'default' namespace." }}
    {{- end }}

    # 4. Allow whitelisted internal services (if any)
    {{- range .Values.workerNetworkPolicy.allowedInternalCIDRs }}
    - to:
        - ipBlock:
            cidr: {{ . }}
    {{- end }}

    # 5. THE RULE: Allow Internet, but BLOCK Internal Cluster IPs
    # Exceptions above (rules 1-4) take precedence over this block
    - to:
        - ipBlock:
            cidr: 0.0.0.0/0           # Allow All Public IPs
            except:
              - 10.0.0.0/8            # Block Private Cluster Network A
              - 172.16.0.0/12         # Block Private Cluster Network B
              - 192.168.0.0/16        # Block Private Cluster Network C
              - 169.254.169.254/32    # Block Cloud Metadata API
              {{- with .Values.workerNetworkPolicy.additionalBlockedCIDRs }}
              {{- toYaml . | nindent 14 }}
              {{- end }}
{{- end }}
