{{- include "job-manager.validateLocation" . -}}
{{- include "job-manager.validateRuntimes" . -}}
apiVersion: apps/v1
kind: Deployment
metadata:
  name: {{ include "job-manager.fullname" . }}
  namespace: {{ .Release.Namespace }}
  labels:
    {{- include "job-manager.labels" . | nindent 4 }}
    {{- include "job-manager.locationLabels" . | nindent 4 }}
    {{- with .Values.labels -}}
      {{ toYaml . | nindent 4 }}
    {{- end }}
spec:
  replicas: 1
  selector:
    matchLabels:
      {{- include "job-manager.selectorLabels" . | nindent 6 }}
  template:
    metadata:
      labels:
        {{- include "job-manager.selectorLabels" . | nindent 8 }}
        {{- include "job-manager.locationLabels" . | nindent 8 }}
        {{- with .Values.labels -}}
          {{ toYaml . | nindent 8 }}
        {{- end }}
      {{- include "job-manager.podAnnotations" . | nindent 6 }}
    spec:
      {{- if .Values.serviceAccount.create }}
      serviceAccountName: {{ include "job-manager.serviceAccountName" . }}
      {{- end }}
      securityContext:
        {{- toYaml .Values.podSecurityContext | nindent 8 }}
      containers:
        - name: {{ .Chart.Name }}
          securityContext:
            {{- toYaml .Values.securityContext | nindent 12 }}
          image: "{{ .Values.image.repository }}:{{ include "job-manager.appVersion" . }}"
          imagePullPolicy: {{ .Values.image.pullPolicy }}
          env:
            - name: LOCATION_KEY
              {{- include "job-manager.locationKey" . | nindent 14 }}
            - name: LOG_LEVEL
              value: {{ .Values.jobManager.logLevel | quote }}
            {{- if .Values.jobManager.brokerApiEndpoint }}
            - name: BROKER_API_ENDPOINT
              value: {{ .Values.jobManager.brokerApiEndpoint | quote }}
            {{- end }}
            {{- include "job-manager.vsePassphrase" . | nindent 12 -}}

            {{- include "job-manager.apiProxyHost" . | nindent 12 -}}
            {{- include "job-manager.apiProxyPort" . | nindent 12 -}}
            {{- if .Values.jobManager.brokerApiProxySelfSignedCert }}
            - name: BROKER_API_PROXY_ACCEPT_SELF_SIGNED_CERT
              value: {{ .Values.jobManager.brokerApiProxySelfSignedCert | quote }}
            {{- end }}
            {{- if .Values.jobManager.brokerApiProxyUsername }}
            - name: BROKER_API_PROXY_USERNAME
              value: {{ .Values.jobManager.brokerApiProxyUsername | quote }}
            {{- end }}
            {{- if .Values.jobManager.brokerApiProxyPw }}
            - name: BROKER_API_PROXY_PW
              value: {{ .Values.jobManager.brokerApiProxyPw | quote }}
            {{- end }}
            {{- if .Values.global.checkTimeout }}
            - name: CHECK_TIMEOUT
              value: {{ .Values.global.checkTimeout | quote }}
            {{- end }}
            {{- if (.Values.jobManager.userDefinedVariables).userDefinedJson }}
            - name: USER_DEFINED_VARIABLES
              value: {{ .Values.jobManager.userDefinedVariables.userDefinedJson | quote }}
            {{- end }}
            - name: HEAVYWEIGHT_WORKERS
              value: {{ include "job-manager.runtimeParallelism" . | quote }}

            {{/* Location metadata environment variables */}}
            - name: LOCATION_NAME
              value: {{ .Values.jobManager.location.name | quote }}
            {{- if .Values.jobManager.location.id }}
            - name: LOCATION_ID
              value: {{ .Values.jobManager.location.id | quote }}
            {{- end }}
            {{- if .Values.jobManager.location.description }}
            - name: LOCATION_DESCRIPTION
              value: {{ .Values.jobManager.location.description | quote }}
            {{- end }}
            {{- if .Values.jobManager.location.tags.region }}
            - name: LOCATION_REGION
              value: {{ .Values.jobManager.location.tags.region | quote }}
            {{- end }}
            {{- if .Values.jobManager.location.tags.provider }}
            - name: LOCATION_PROVIDER
              value: {{ .Values.jobManager.location.tags.provider | quote }}
            {{- end }}
            {{- if .Values.jobManager.location.tags.environment }}
            - name: LOCATION_ENVIRONMENT
              value: {{ .Values.jobManager.location.tags.environment | quote }}
            {{- end }}

            {{/* Multi-tenant configuration */}}
            {{- if .Values.jobManager.multiTenant.enabled }}
            - name: MULTI_TENANT_ENABLED
              value: "true"
            - name: MAX_CONCURRENT_JOBS
              value: {{ .Values.jobManager.multiTenant.capacity.maxConcurrentJobs | quote }}
            - name: PER_ACCOUNT_QUOTA
              value: {{ .Values.jobManager.multiTenant.capacity.perAccountQuota | quote }}
            {{- if .Values.jobManager.multiTenant.accountValidation.enabled }}
            - name: ACCOUNT_VALIDATION_ENABLED
              value: "true"
            - name: ACCOUNT_VALIDATION_ENDPOINT
              value: {{ .Values.jobManager.multiTenant.accountValidation.validationEndpoint | quote }}
            {{- end }}
            {{- end }}

          {{- /*
          TODO - The following are not yet implemented

            {{- if .Values.jobManager.networkHealthCheckDisabled }}
            - name: NETWORK_HEALTHCHECK_DISABLED
              value: {{ .Values.jobManager.networkHealthCheckDisabled | quote }}
            {{- end }}

            {{- if .Values.appArmorProfileName }}
            - name: RUNNER_APPARMOR
              value: "{{ .Values.appArmorProfileName }}"
            {{- end }}

            {{- if .Values.jobManager.jvmOpts }}
            - name: JVM_OPTS
              value: "{{ .Values.jobManager.jvmOpts }}"
            {{- end }}
          */}}
          {{ if include "job-manager.toMount" . }}
          volumeMounts:
            {{- include "job-manager.volumeMounts" . | nindent 12 }}
          {{ end }}
          ports:
            - name: http
              containerPort: 8080
              protocol: TCP
            - name: admin
              containerPort: 8082
              protocol: TCP
          startupProbe:
            httpGet:
              path: /status/check
              port: http
            # Allow up to 10 minutes for startup before marking as failed
            failureThreshold: {{ .Values.startupProbeFailureThreshold }}
            periodSeconds: {{ .Values.startupProbePeriodSeconds }}

          livenessProbe:
            httpGet:
              path: /status/check
              port: http
            # If two consecutive failures occur the liveness check fails
            failureThreshold: {{ .Values.livenessProbeFailureThreshold }}
            periodSeconds: {{ .Values.livenessProbePeriodSeconds }}
            timeoutSeconds: {{ .Values.livenessProbeTimeoutSeconds }}

          resources:
            {{- toYaml .Values.resources | nindent 12 }}
          terminationMessagePolicy: FallbackToLogsOnError

      terminationGracePeriodSeconds: {{ include "job-manager.terminationGracePeriodSeconds" . }}

      {{- with .Values.nodeSelector }}
      nodeSelector:
        {{- toYaml . | nindent 8 }}
      {{- end }}

      {{- with .Values.affinity }}
      affinity:
        {{- toYaml . | nindent 8 }}
      {{- end }}

      {{- with .Values.tolerations }}
      tolerations:
        {{- toYaml . | nindent 8 }}
      {{- end }}

      {{- with .Values.imagePullSecrets }}
      imagePullSecrets:
        {{- toYaml . | nindent 8 }}
      {{- end }}

      restartPolicy: Always
      {{ if include "job-manager.toMount" . }}
      volumes:
        {{ if (.Values.jobManager.userDefinedVariables).userDefinedFile }}
        - name: {{ include "job-manager.configMapName" . | quote }}
          configMap:
            name: {{ include "job-manager.configMapName" . | quote }}
        {{ end }}
        - name: {{ include "job-manager.volumeName" . | quote }}
          persistentVolumeClaim:
            claimName: {{ include "job-manager.claimName" . | quote }}
      {{ end }}
