suite: Validate agent-control-cd Installation
tests:
  - it: should leverage correct image tag
    set:
      toolkitImage:
        tag: 123
        repository: test
    asserts:
      - template: templates/installation-job.yaml
        equal:
          path: spec.template.spec.containers[0].image
          value: "test:123"
      - template: templates/uninstallation-job.yaml
        equal:
          path: spec.template.spec.containers[0].image
          value: "test:123"
  - it: should allow custom repositoryUrl
    set:
      agentControlCd:
        chartRepositoryUrl: "https://example.com/some/url"
    asserts:
      - template: templates/installation-job.yaml
        matchRegex:
          path: spec.template.spec.containers[0].args[0]
          pattern: (?s).*https\:\/\/example\.com\/some\/url\s.*

  - it: should accept no repositoryUrl
    asserts:
      - template: templates/installation-job.yaml
        matchRegex:
          path: spec.template.spec.containers[0].args[0]
          pattern: (?s).*https:\/\/helm-charts\.newrelic\.com\s.*

  - it: should mount the TLS certificate secrets if configured
    set:
      agentControlCd:
        repositoryCertificateSecretReferenceName: my-cert-secret
    asserts:
      - template: templates/installation-job.yaml
        equal:
          path: spec.template.spec.volumes[1].secret.items
          value:
            - key: ca.crt
              path: ca.crt
            - key: tls.crt
              path: tls.crt
            - key: tls.key
              path: tls.key
      - template: templates/installation-job.yaml
        matchRegex:
          path: spec.template.spec.containers[0].args[0]
          pattern: \\\s+--ca-file /etc/flux-cert/ca\.crt

  - it: should use basic auth when configured
    set:
      agentControlCd:
        repositorySecretReferenceName: my-basic-auth-secret
    asserts:
      - template: templates/installation-job.yaml
        matchRegex:
          path: spec.template.spec.containers[0].args[0]
          pattern: \\\s+--username

  - it: if basic auth and TLS are configured, uses TLS
    set:
      agentControlCd:
        repositoryCertificateSecretReferenceName: my-cert-secret
        repositorySecretReferenceName: my-basic-auth-secret
    asserts:
      - template: templates/installation-job.yaml
        matchRegex:
          path: spec.template.spec.containers[0].args[0]
          pattern: "--cert-file /etc/flux-cert/tls.crt"
      - template: templates/installation-job.yaml
        notMatchRegex:
          path: spec.template.spec.containers[0].args[0]
          pattern: "--password"

  - it: should install agent-control-cd through helm
    asserts:
      - template: templates/installation-job.yaml
        matchRegex:
          path: spec.template.spec.containers[0].args[0]
          pattern: "helm upgrade --install"
