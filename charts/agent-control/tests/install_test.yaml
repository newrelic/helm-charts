suite: Validate AC Installation
chart:
  appVersion: 0.0.0
tests:
  - it: should have defaults args correctly set
    asserts:
      - template: templates/install.yaml
        equal:
          path: spec.template.spec.containers[0].args
          value:
            - |-
              echo "Creating Flux's CD resources..."
              newrelic-agent-control-cli create-cd-resources \
                --chart-version=0.0.2 \
                --secrets=RELEASE-NAME-deployment-flux=agent-control-flux.yaml \
                --namespace=NAMESPACE \
                --repository-url=https://helm-charts.newrelic.com \
                --log-level=debug \
                --chart-name=agent-control-cd

              echo "Creating agent-control-deployment resources..."
              newrelic-agent-control-cli install-agent-control \
                --chart-version=0.0.0 \
                --secrets=RELEASE-NAME-deployment=agent-control-deployment.yaml,RELEASE-NAME-deployment=global.yaml \
                --namespace=NAMESPACE \
                --repository-url=https://helm-charts.newrelic.com \
                --log-level=debug \
                --chart-name=agent-control-deployment

  - it: should configure arguments correctly
    set:
      installation:
        log:
          level: trace
      uninstallation:
        log:
          level: trace
      agentControlDeployment:
        chartVersion: "1.2.3"
        chartRepositoryUrl: "https://newrelic.com/some/url"
        chartName: "custom-deployment"
        repositorySecretReferenceName: secret-ref
        repositoryCertificateSecretReferenceName: cert-secret-ref
      agentControlCd:
        chartVersion: "3.2.1"
        chartRepositoryUrl: "https://newrelic.com/other/url"
        chartName: "custom-flux"

    asserts:
      - template: templates/install.yaml
        equal:
          path: spec.template.spec.containers[0].args
          value:
            - |-
              echo "Creating Flux's CD resources..."
              newrelic-agent-control-cli create-cd-resources \
                --chart-version=3.2.1 \
                --secrets=RELEASE-NAME-deployment-flux=agent-control-flux.yaml \
                --namespace=NAMESPACE \
                --repository-url=https://newrelic.com/other/url \
                --log-level=trace \
                --chart-name=custom-flux

              echo "Creating agent-control-deployment resources..."
              newrelic-agent-control-cli install-agent-control \
                --chart-version=1.2.3 \
                --secrets=RELEASE-NAME-deployment=agent-control-deployment.yaml,RELEASE-NAME-deployment=global.yaml \
                --namespace=NAMESPACE \
                --repository-url=https://newrelic.com/some/url \
                --log-level=trace \
                --repository-secret-reference-name=secret-ref \
                --repository-certificate-secret-reference-name=cert-secret-ref \
                --chart-name=custom-deployment

  - it: should leverage correct image tag
    set:
      toolkitImage:
        tag: 123
        repository: test
    asserts:
      - template: templates/install.yaml
        equal:
          path: spec.template.spec.containers[0].image
          value: "test:123"
      - template: templates/uninstall.yaml
        equal:
          path: spec.template.spec.containers[0].image
          value: "test:123"
