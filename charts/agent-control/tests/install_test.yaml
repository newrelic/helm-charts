suite: Validate AC Installation
chart:
  appVersion: 0.0.0
tests:
  - it: should have defaults args correctly set
    asserts:
      - template: templates/install.yaml
        equal:
          path: spec.template.spec.containers[0].args
          value: 
            - |-
              echo "Creating agent-control-deployment resources..."
              newrelic-agent-control-cli install-agent-control \
                --chart-version=0.0.0 \
                --secrets=RELEASE-NAME-deployment=agent-control-deployment.yaml,RELEASE-NAME-deployment=global.yaml \
                --namespace=NAMESPACE \
                --repository-url=https://helm-charts.newrelic.com \
                --log-level=info \
                --chart-name=agent-control-deployment
              echo "Creating Flux's CD resources..."
              newrelic-agent-control-cli create-flux-resources \
                --chart-version=0.0.2 \
                --secrets=RELEASE-NAME-deployment-flux=agent-control-flux.yaml \
                --namespace=NAMESPACE \
                --repository-url=https://helm-charts.newrelic.com \
                --log-level=info \
                --chart-name=agent-control-cd

  - it: should configure arguments correctly
    set:
      installationJob:
        agentControlDeployment:
          chartVersion: "0.0.0"
          chartRepositoryUrl: "https://newrelic.com/some/url"
          chartName: "custom-deployment"
          repositorySecretReferenceName: secret-ref
          repositoryCertificateSecretReferenceName: cert-secret-ref 
        agentControlCd:
          chartVersion: "0.0.2"
          chartRepositoryUrl: "https://newrelic.com/other/url"
          chartName: "custom-flux"

    asserts:
      - template: templates/install.yaml
        equal:
          path: spec.template.spec.containers[0].args
          value: 
            - |-
              echo "Creating agent-control-deployment resources..."
              newrelic-agent-control-cli install-agent-control \
                --chart-version=0.0.0 \
                --secrets=RELEASE-NAME-deployment=agent-control-deployment.yaml,RELEASE-NAME-deployment=global.yaml \
                --namespace=NAMESPACE \
                --repository-url=https://newrelic.com/some/url \
                --log-level=info \
                --repository-secret-reference-name=secret-ref \
                --repository-certificate-secret-reference-name=cert-secret-ref \
                --chart-name=custom-deployment
              echo "Creating Flux's CD resources..."
              newrelic-agent-control-cli create-flux-resources \
                --chart-version=0.0.2 \
                --secrets=RELEASE-NAME-deployment-flux=agent-control-flux.yaml \
                --namespace=NAMESPACE \
                --repository-url=https://newrelic.com/other/url \
                --log-level=info \
                --chart-name=custom-flux

  - it: should leverage correct image tag
    set:
      toolkitImage:
        tag: 123
        repository: test
    asserts:
      - template: templates/install.yaml
        equal:
          path: spec.template.spec.containers[0].image
          value: "test:123"
      - template: templates/uninstall.yaml
        equal:
          path: spec.template.spec.containers[0].image
          value: "test:123"
