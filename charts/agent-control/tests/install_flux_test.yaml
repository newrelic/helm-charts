suite: Validate AC-CD Installation
tests:
  - it: should leverage correct image tag
    set:
      agent-control-cd:
        installer:
          image:
            tag: 123
            repository: test
    asserts:
      - template: templates/install-flux.yaml
        equal:
          path: spec.template.spec.containers[0].image
          value: "test:123"
      - template: templates/uninstall-flux.yaml
        equal:
          path: spec.template.spec.containers[0].image
          value: "test:123"
  - it: should allow custom repositoryUrl
    set:
      agent-control-cd:
        chartRepositoryUrl: "https://example.com/some/url"
    asserts:
      - template: templates/install-flux.yaml
        matchRegex:
          path: spec.template.spec.containers[0].args[0]
          pattern: (?s).*https\:\/\/example\.com\/some\/url\s.*

  - it: should accept no repositoryUrl
    asserts:
      - template: templates/install-flux.yaml
        matchRegex:
          path: spec.template.spec.containers[0].args[0]
          pattern: (?s).*https:\/\/helm-charts\.newrelic\.com\s.*

  - it: should mount the TLS certificate secrets if configured
    set:
      installationJob:
        agentControlCd:
          repositoryCertificateSecretReferenceName: my-cert-secret
    asserts:
      - template: templates/install-flux.yaml
        equal:
          path: spec.template.spec.volumes[1].secret.items
          value:
            - key: ca.crt
              path: ca.crt
            - key: tls.crt
              path: tls.crt
            - key: tls.key
              path: tls.key
      - template: templates/install-flux.yaml
        matchRegex:
          path: spec.template.spec.containers[0].args[0]
          pattern: "--cert-file /etc/flux-cert/tls.crt"

  - it: should use basic auth when configured
    set:
      installationJob:
        agentControlCd:
          repositorySecretReferenceName: my-basic-auth-secret
    asserts:
      - template: templates/install-flux.yaml
        matchRegex:
          path: spec.template.spec.containers[0].args[0]
          pattern: "--password"

  - it: if basic auth and TLS are configured, uses TLS
    set:
      installationJob:
        agentControlCd:
          repositoryCertificateSecretReferenceName: my-cert-secret
          repositorySecretReferenceName: my-basic-auth-secret
    asserts:
      - template: templates/install-flux.yaml
        matchRegex:
          path: spec.template.spec.containers[0].args[0]
          pattern: "--cert-file /etc/flux-cert/tls.crt"
      - template: templates/install-flux.yaml
        notMatchRegex:
          path: spec.template.spec.containers[0].args[0]
          pattern: "--password"
