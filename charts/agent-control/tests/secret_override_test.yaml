suite: Validate Secret Override Logic
chart:
  appVersion: 0.0.0

tests:
  - it: should encode cdRemoteUpdate as false when flux2 is disabled
    set:
      agent-control-deployment:
        enabled: true
        cdRemoteUpdate: true
      agent-control-cd:
        flux2:
          enabled: false
    asserts:
      - template: templates/ac-deployment-secret.yaml
          # Assert: Verify the Base64 encoded value in the 'agent-control-deployment.yaml' key.
          #
          # The decoded value of the string below should be:
          # ------------------------------------------
          #   acRemoteUpdate: true
          #   cdRemoteUpdate: false
          #   enabled: true
          #   subAgentsNamespace: newrelic
          # ------------------------------------------
          # To debug a failing test, copy the actual Base64 output and decode it with:
          # echo "BASE64_STRING_HERE" | base64 --decode
        equal:
          path: data["agent-control-deployment.yaml"]
          value: YWNSZW1vdGVVcGRhdGU6IHRydWUKY2RSZW1vdGVVcGRhdGU6IGZhbHNlCmVuYWJsZWQ6IHRydWUKc3ViQWdlbnRzTmFtZXNwYWNlOiBuZXdyZWxpYw==

  - it: should encode the user's value for cdRemoteUpdate when flux2 is enabled
    set:
      agent-control-deployment:
        enabled: true
        cdRemoteUpdate: true
      agent-control-cd:
        flux2:
          enabled: true
    asserts:
      - template: templates/ac-deployment-secret.yaml
          # Assert: Verify the Base64 encoded value in the 'agent-control-deployment.yaml' key.
          #
          # The decoded value of the string below should be:
          # ------------------------------------------
          #   acRemoteUpdate: true
          #   cdRemoteUpdate: true
          #   enabled: true
          #   subAgentsNamespace: newrelic
          # ------------------------------------------
          # To debug a failing test, copy the actual Base64 output and decode it with:
          # echo "BASE64_STRING_HERE" | base64 --decode
        equal:
          path: data["agent-control-deployment.yaml"]
          value: YWNSZW1vdGVVcGRhdGU6IHRydWUKY2RSZW1vdGVVcGRhdGU6IHRydWUKZW5hYmxlZDogdHJ1ZQpzdWJBZ2VudHNOYW1lc3BhY2U6IG5ld3JlbGlj

