suite: pre-install job template
templates:
  - templates/preinstall-job-register-system-identity.yaml
release:
  name: agent-control
  namespace: my-namespace
set:
  cluster: test
  licenseKey: test
tests:
  - it: by default it fails with missing values
    asserts:
      - failedTemplate:
          errorMessage: You must specify in .Values.systemIdentity a secretName or identityClientId identityClientSecret/identityClientAuthToken


  - it: it fails with no organizationId
    set:
      systemIdentity:
        parentIdentity:
          clientId: test
          clientSecret: test
    asserts:
      - failedTemplate:
          errorMessage: You should specify .Values.systemIdentity.organizationId

  - it: by default it fails when specifying conflicting values clientAuth vs clietnSecret
    set:
      systemIdentity:
        parentIdentity:
          clientId: test
          clientSecret: test
          authToken: test
        organizationId: test
    asserts:
      - failedTemplate:
          errorMessage: You should not specify in .Values.systemIdentity both a identityClientSecret and a identityClientAuthToken

  - it: by default it fails when specifying conflicting values fromSecret vs credendials
    set:
      systemIdentity:
        parentIdentity:
          clientId: test
          clientSecret: test
          fromSecret: test-client-name
        organizationId: test
    asserts:
      - failedTemplate:
          errorMessage: You should not specify in .Values.systemIdentity both a secretName and identityClientId identityClientSecret/identityClientAuthToken

  - it: with fleet disabled, the job should template correctly 0 documents.
    set:
      config:   
        fleet_control:
          enabled: false
    asserts:
      - hasDocuments:
          count: 0

  - it: with identityClientId/identityClientSecret set, the job should template correctly.
    set:
      systemIdentity:
        parentIdentity:
          clientId: test
          clientSecret: test
        organizationId: test
            
    asserts:
      - hasDocuments:
          count: 5 # Secret, job, and 3 RBAC manifests
      - documentIndex: 0
        equal:
          path: data
          value:
            NEW_RELIC_AUTH_CLIENT_ID: dGVzdA==
            NEW_RELIC_AUTH_CLIENT_SECRET: dGVzdA==
            NEW_RELIC_AUTH_TOKEN: null
      - documentIndex: 1
        isNotNullOrEmpty:
          path: spec.template.spec.containers[0].args
      - documentIndex: 1
        equal:
          path: spec.template.spec.containers[0].envFrom
          value:
            - secretRef:
                name: agent-control-preinstall-client-credentials

  - it: with identityClientId/identityClientAuthToken set, the job should template correctly.
    set:
      systemIdentity:
        parentIdentity:
          clientId: test
          authToken: test
        organizationId: test  
       
    asserts:
      - hasDocuments:
          count: 5 # Secret, job, and 3 RBAC manifests
      - documentIndex: 0
        equal:
          path: data
          value:
            NEW_RELIC_AUTH_CLIENT_ID: dGVzdA==
            NEW_RELIC_AUTH_CLIENT_SECRET: null
            NEW_RELIC_AUTH_TOKEN: dGVzdA==
      - documentIndex: 1
        isNotNullOrEmpty:
          path: spec.template.spec.containers[0].args
      - documentIndex: 1
        equal:
          path: spec.template.spec.containers[0].envFrom
          value:
            - secretRef:
                name: agent-control-preinstall-client-credentials

  - it: with a custom secret for clientId and clientSecret, the secret should not be created.
    set:
      systemIdentity:
        parentIdentity:
          fromSecret: test-client-name
        organizationId: test  
    asserts:
      - hasDocuments:
          count: 4 # With everything rendered it should be 5
      - documentIndex: 0
        isNotNullOrEmpty:
          path: spec.template.spec.containers[0].args
      - documentIndex: 0
        equal:
          path: spec.template.spec.containers[0].envFrom
          value:
            - secretRef:
                name: test-client-name

  - it: setting specific image for system identity registration with tag should use the provided tag
    set:
      systemIdentity:
        parentIdentity:
          fromSecret: test-client-name
        organizationId: test  
        image:
          tag: 1.0.0
    asserts:
      - documentIndex: 0
        equal:
          path: spec.template.spec.containers[0].image
          value: newrelic/agent-control-system-identity-registration:1.0.0

  - it: setting specific image for system identity registration with tag should use the provided data
    set:
      systemIdentity:
        parentIdentity:
          fromSecret: test-client-name
        organizationId: test  
        image:
          repository: some_namespace/test-image
          tag: 1.0.0
    asserts:
      - documentIndex: 0
        equal:
          path: spec.template.spec.containers[0].image
          value: some_namespace/test-image:1.0.0

  - it: setting specific pullPolicy for system identity registration image should use the provided data
    set:
      systemIdentity:
        parentIdentity:
          fromSecret: test-client-name
        organizationId: test  
        image:
          pullPolicy: Always
    asserts:
      - documentIndex: 0
        equal:
          path: spec.template.spec.containers[0].imagePullPolicy
          value: Always
