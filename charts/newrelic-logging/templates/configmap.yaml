apiVersion: v1
kind: ConfigMap
metadata:
  namespace: {{ .Release.Namespace }}
  labels: {{ include "newrelic-logging.labels" . | indent 4 }}
  name: {{ template "newrelic-logging.fluentBitConfig" . }}
data:
  {{- if (include "newrelic-logging.lowDataMode" .) }}
  {{ $lowDataDefault := .Files.Get "static/lowdatamodedefaults.yaml" }}
    {{- $lowDataDefault }}
  {{- else }}
  fluent-bit.conf: |
    {{- if .Values.fluentBit.config.service }}
      {{- .Values.fluentBit.config.service | nindent 4 }}
    {{ end }}
    {{- if .Values.fluentBit.config.inputs }}
      {{- .Values.fluentBit.config.inputs | nindent 4 }}
    {{ end }}
    {{- if .Values.fluentBit.config.filters }}
      {{- .Values.fluentBit.config.filters | nindent 4 }}
    {{ end }}
    {{- if .Values.fluentBit.config.outputs }}
      {{- .Values.fluentBit.config.outputs | nindent 4 }}
    {{- end }}
  {{ end }}
  parsers.conf: |
  {{- if .Values.fluentBit.config.parsers }}
    {{- .Values.fluentBit.config.parsers | nindent 4}}
  {{- else }}
    # Relevant parsers retrieved from: https://github.com/fluent/fluent-bit/blob/master/conf/parsers.conf
    [PARSER]
        Name         docker
        Format       json
        Time_Key     time
        Time_Format  %Y-%m-%dT%H:%M:%S.%L
        Time_Keep    On

    [PARSER]
        Name cri
        Format regex
        Regex ^(?<time>[^ ]+) (?<stream>stdout|stderr) (?<logtag>[^ ]*) (?<message>.*)$
        Time_Key    time
        Time_Format %Y-%m-%dT%H:%M:%S.%L%z
    {{- end }}
    